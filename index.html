<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Dual-Analysis Draft Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            direction: rtl;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        th {
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .rank-bar {
             background: linear-gradient(to right, #d1d5db, #6ee7b7, #10b981);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .status-a { color: #16a34a; }
        .status-i { color: #dc2626; }
        .status-d { color: #f59e0b; }
        .status-s { color: #f97316; }
        .status-u { color: #6b7280; }
        
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center;
            border-radius: 6px; padding: 5px 10px; position: absolute; z-index: 1; bottom: 125%;
            left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s;
            font-size: 0.875rem; direction: ltr;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .pitch {
            background-color: #008053;
            border: 2px solid #fff;
            position: relative;
            overflow: hidden;
        }
        .pitch-line { background-color: rgba(255,255,255,0.5); position: absolute; }
        .center-line { width: 2px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); }
        .center-circle { width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .penalty-box { border: 2px solid rgba(255,255,255,0.5); position: absolute; }
        .box-top { height: 100px; width: 60%; top: 0; left: 20%; }
        .box-bottom { height: 100px; width: 60%; bottom: 0; left: 20%; }

        .player-shirt {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            padding: 2px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            position: relative;
            min-width: 64px;
        }
        #alert-box {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-900">FPL Dual-Analysis Draft Tool</h1>
            <p class="text-lg text-gray-600 mt-2">כלי עזר לבחירת שחקנים בדראפט, מבוסס על שני מודלי ניתוח נפרדים</p>
        </header>
        
        <div id="alert-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform -translate-y-12 z-50">
            <p id="alert-message"></p>
        </div>

        <div id="main-content" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 space-y-6">
                    <!-- FPL API Analysis -->
                    <div>
                        <h2 class="text-2xl font-bold mb-2">המלצה מס' 1: כלי הדראפט החי (מבוסס FPL API)</h2>
                        <div class="bg-blue-50 border-r-4 border-blue-500 text-blue-800 p-3 rounded-lg text-sm mb-4">
                            <p>מדרג שחקנים על סמך מדדי הפוטנציאל של FPL. טוב לזיהוי שחקנים עם "תקרה גבוהה" על בסיס מדדי ICT ו-BPS. **מכאן מבצעים את הבחירות לדראפט.**</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md mb-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="search-player" class="w-full rounded-md border-gray-300 shadow-sm" placeholder="חיפוש שחקן...">
                            <select id="position-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                                <option value="all">כל העמדות</option>
                                <option value="GKP">שוערים</option>
                                <option value="DEF">הגנה</option>
                                <option value="MID">קישור</option>
                                <option value="FWD">התקפה</option>
                            </select>
                            <select id="team-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                                <option value="all">כל הקבוצות</option>
                            </select>
                            <select id="status-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                                <option value="all">כל הסטטוסים</option>
                                <option value="a">זמינים</option>
                                <option value="d">בספק</option>
                                <option value="i">פצועים</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto bg-white rounded-lg shadow max-h-[60vh]">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500" data-sort-fpl="web_name">שחקן</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500" data-sort-fpl="fpl_rank">דירוג</th>
                                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort-fpl="points_per_game">נק'/משחק</th>
                                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort-fpl="ict_index">ICT</th>
                                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort-fpl="bps">BPS</th>
                                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort-fpl="status">סטטוס</th>
                                    </tr>
                                </thead>
                                <tbody id="fpl-players-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- FBref Analysis -->
                    <div>
                        <h2 class="text-2xl font-bold mb-2">המלצה מס' 2: דירוג ביצועים (מבוסס FBref)</h2>
                         <div class="bg-green-50 border-r-4 border-green-500 text-green-800 p-3 rounded-lg text-sm mb-4">
                            <p>מדרג שחקנים על סמך הביצועים המוכחים שלהם בעונה שעברה. טוב לבחירות בטוחות וליבת הסגל.</p>
                        </div>
                        <div class="overflow-x-auto bg-white rounded-lg shadow max-h-[60vh]">
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500" data-sort-fbref="Player">שחקן</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500" data-sort-fbref="performance_rank">דירוג</th>
                                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort-fbref="performance_ratio">יחס ביצוע</th>
                                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort-fbref="xG_xA">xG+xA</th>
                                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort-fbref="Gls">שערים</th>
                                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort-fbref="Ast">בישולים</th>
                                    </tr>
                                </thead>
                                <tbody id="fbref-players-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                     <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-bold">הקבוצה שלי</h2>
                        <div class="text-left">
                            <div class="font-bold text-lg">£<span id="total-cost">0.0</span>m</div>
                            <div class="text-xs text-gray-500">שווי קבוצה</div>
                        </div>
                    </div>
                     <div class="flex justify-between items-center mb-4 bg-gray-200 p-2 rounded-lg">
                        <div id="squad-counts" class="text-xs font-semibold grid grid-cols-4 gap-1 text-center">
                            <div>שוערים: <span id="gkp-count">0</span>/2</div>
                            <div>מגנים: <span id="def-count">0</span>/5</div>
                            <div>קשרים: <span id="mid-count">0</span>/5</div>
                            <div>חלוצים: <span id="fwd-count">0</span>/3</div>
                        </div>
                        <div class="font-bold text-lg"><span id="drafted-count">0</span>/15</div>
                    </div>
                    <div id="pitch" class="pitch h-[500px] p-2 rounded-lg flex flex-col justify-around">
                         <div class="pitch-line center-line"></div>
                         <div class="pitch-line center-circle"></div>
                         <div class="pitch-line penalty-box box-top"></div>
                         <div class="pitch-line penalty-box box-bottom"></div>
                         
                         <div class="relative"><div class="absolute -top-2 right-2 text-white text-xs opacity-70">חלוצים</div><div id="forwards" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                         <div class="relative"><div class="absolute -top-2 right-2 text-white text-xs opacity-70">קשרים</div><div id="midfielders" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                         <div class="relative"><div class="absolute -top-2 right-2 text-white text-xs opacity-70">מגנים</div><div id="defenders" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                         <div class="relative"><div class="absolute -top-2 right-2 text-white text-xs opacity-70">שוערים</div><div id="goalkeepers" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-xl font-bold mb-2 text-center">ספסל</h3>
                        <div id="bench" class="bg-gray-200 p-2 rounded-lg flex justify-center items-center gap-2 flex-wrap min-h-[120px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loader-container" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-50">
        <div class="loader"></div>
        <p id="loader-text" class="ml-4 text-lg text-white">טוען נתונים עדכניים...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const CORS_PROXY = `https://corsproxy.io/?`;
            const FPL_API_URL = `${CORS_PROXY}${encodeURIComponent('https://fantasy.premierleague.com/api/bootstrap-static/')}`;
            const GSHEET_PLAYERS_PL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKIuoEaZAxse7L6MKQHDdJV2F7abkyjYsEDP7ohHfUpUyvtDx8tLJB6LW0Jq9nYA/pub?gid=1364430832&single=true&output=csv";
            const GSHEET_PLAYERS_CHAMP = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKIuoEaZAxse7L6MKQHDdJV2F7abkyjYsEDP7ohHfUpUyvtDx8tLJB6LW0Jq9nYA/pub?gid=618999132&single=true&output=csv";
            
            let allFplPlayers = [];
            let allFbrefPlayers = [];
            let draftedPlayers = JSON.parse(localStorage.getItem('draftedPlayers')) || [];
            let fplSortConfig = { key: 'fpl_rank', direction: 'desc' };
            let fbrefSortConfig = { key: 'performance_rank', direction: 'desc' };

            const SQUAD_LIMITS = { TOTAL: 15, GKP: 2, DEF: 5, MID: 5, FWD: 3 };

            const loader = document.getElementById('loader-container');
            const mainContent = document.getElementById('main-content');
            mainContent.style.display = 'none';

            function scale(values) {
                const min = Math.min(...values);
                const max = Math.max(...values);
                return max === min ? values.map(() => 0.5) : values.map(v => (v - min) / (max - min));
            }

            async function analyzeFplData() {
                try {
                    const res = await fetch(FPL_API_URL);
                    if (!res.ok) throw new Error('Failed to fetch FPL data');
                    const fplData = await res.json();
                    
                    let players = fplData.elements;
                    const teamsMap = new Map(fplData.teams.map(t => [t.id, t.name]));
                    const posMap = new Map(fplData.element_types.map(p => [p.id, p.singular_name_short]));

                    const playerPosIds = new Set(fplData.element_types.filter(p => p.singular_name !== 'Manager').map(p => p.id));
                    players = players.filter(p => playerPosIds.has(p.element_type));

                    players.forEach(p => {
                        p.position = posMap.get(p.element_type);
                        p.team_name = teamsMap.get(p.team);
                        ['ict_index', 'bps', 'total_points', 'now_cost', 'points_per_game'].forEach(col => p[col] = parseFloat(p[col] || 0));
                    });

                    const normalized = {
                        ict: scale(players.map(p => p.ict_index)),
                        bps: scale(players.map(p => p.bps))
                    };

                    const weights = {
                        'GKP': {'ict': 0.7, 'bps': 0.3},
                        'DEF': {'ict': 0.8, 'bps': 0.2},
                        'MID': {'ict': 0.85, 'bps': 0.15},
                        'FWD': {'ict': 0.9, 'bps': 0.1}
                    };

                    players.forEach((p, i) => {
                        let rank = 0;
                        const posWeights = weights[p.position];
                        if (posWeights) {
                            for (const [metric, weight] of Object.entries(posWeights)) {
                                rank += (normalized[metric][i] || 0) * weight;
                            }
                        }
                        p.fpl_rank = rank * 100;
                    });
                    return { players, weights };
                } catch (e) {
                    console.error("FPL Analysis failed:", e);
                    return { players: [], weights: {} };
                }
            }
            
            async function analyzeFbrefData(playerUrls) {
                 try {
                    const [plRes, champRes] = await Promise.all([
                        fetch(playerUrls.pl),
                        fetch(playerUrls.champ)
                    ]);
                    const plText = await plRes.text();
                    const champText = await champRes.text();
                    
                    const parseCsv = (text) => {
                        const rows = text.split('\r\n').slice(1); // Use \r\n and skip header
                        const headers = text.split('\r\n')[0].split(',');
                        return rows.map(rowStr => {
                            const values = rowStr.split(',');
                            const row = {};
                            headers.forEach((header, i) => {
                                row[header.trim()] = values[i];
                            });
                            return row;
                        }).filter(row => row.Player && row.Player !== 'Player');
                    };

                    const dfPl = parseCsv(plText);
                    const dfChamp = parseCsv(champText);
                    
                    let df = dfPl.concat(dfChamp);
                    
                    df.forEach(p => {
                        p.Min = parseFloat(p.Min) || 0;
                        p.Gls = parseFloat(p.Gls) || 0;
                        p.Ast = parseFloat(p.Ast) || 0;
                        p.xG = parseFloat(p.xG) || 0;
                        p.xA = parseFloat(p.xAG) || 0;
                        p.actual_contrib = p.Gls + p.Ast;
                        p.expected_contrib = p.xG + p.xA;
                        p.performance_ratio = p.expected_contrib > 0 ? p.actual_contrib / p.expected_contrib : 0;
                        p.pos_simple = p.Pos ? p.Pos.split(',')[0] : '';
                    });
                    
                    const minutes_filter = df.map(p => p.Min > 400);
                    
                    const components = {
                        xG: df.map(p => p.xG), 
                        xA: df.map(p => p.xA), 
                        performance: df.map(p => p.performance_ratio), 
                        minutes: df.map(p => p.Min)
                    };
                    const normalized = {};
                    for (const key in components) {
                        normalized[key] = scale(components[key]);
                    }
                    
                    const weights = {
                        'GK': {'minutes': 1.0},
                        'DF': {'xA': 0.4, 'xG': 0.4, 'minutes': 0.2},
                        'MF': {'xA': 0.4, 'xG': 0.3, 'performance': 0.3},
                        'FW': {'xG': 0.5, 'performance': 0.4, 'minutes': 0.1}
                    };

                    df.forEach((p, i) => {
                        let rank = 0;
                        const pos = p.pos_simple;
                        if (pos in weights) {
                            for (const [metric, weight] of Object.entries(weights[pos])) {
                                rank += (normalized[metric][i] || 0) * weight;
                            }
                        }
                        if (typeof p.Pos === 'string' && (p.Pos.includes('AM') || p.Pos.includes('W'))) {
                            rank *= 1.05;
                        }
                        p.performance_rank = rank * 100;
                        if (!minutes_filter[i]) {
                            p.performance_rank = 0;
                        }
                    });

                    return df;

                } catch (e) {
                    console.error("FBref Analysis failed:", e);
                    return [];
                }
            }
            
            function render() {
                renderFplTable();
                renderFbrefTable();
                renderDraftedList();
            }

            function renderPlayers(tableId, players, sortConf, columns) {
                const tableBody = document.getElementById(tableId);
                if (!tableBody) return;

                players.sort((a, b) => {
                    const valA = a[sortConf.key];
                    const valB = b[sortConf.key];
                    if (valA < valB) return sortConf.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConf.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                tableBody.innerHTML = players.map(p => `
                    <tr>
                        ${columns.map(col => `<td class="${col.classes}">${col.render(p)}</td>`).join('')}
                    </tr>
                `).join('');
            }

            function renderFplTable() {
                const searchFilter = document.getElementById('search-player').value.toLowerCase();
                const positionFilter = document.getElementById('position-filter').value;
                const statusFilter = document.getElementById('status-filter').value;
                const teamFilter = document.getElementById('team-filter').value;

                let filtered = allFplPlayers.filter(p => !draftedPlayers.includes(p.id));
                if (searchFilter) filtered = filtered.filter(p => p.web_name.toLowerCase().includes(searchFilter) || p.team_name.toLowerCase().includes(searchFilter));
                if (positionFilter !== 'all') filtered = filtered.filter(p => p.position === positionFilter);
                if (statusFilter !== 'all') filtered = filtered.filter(p => p.status === statusFilter);
                if (teamFilter !== 'all') filtered = filtered.filter(p => p.team_name === teamFilter);

                const statusMap = { 'a': '✅', 'd': '❓', 'i': '🚑', 's': '🟥', 'u': '❔' };
                const columns = [
                    { classes: 'px-3 py-4 whitespace-nowrap', render: p => `<div class="flex items-center"><button class="draft-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md transition ml-3" data-id="${p.id}">בחר</button><div><div class="font-bold">${p.web_name}</div><div class="text-sm text-gray-500">${p.team_name} - ${p.position}</div></div></div>` },
                    { classes: 'px-3 py-4 whitespace-nowrap', render: p => `<div class="flex items-center"><span class="font-semibold w-10">${p.fpl_rank.toFixed(1)}</span><div class="w-full bg-gray-200 rounded-full h-2.5 ml-2"><div class="bg-green-600 h-2.5 rounded-full rank-bar" style="width: ${p.fpl_rank}%"></div></div></div>` },
                    { classes: 'px-2 py-4 text-sm font-bold text-center', render: p => p.points_per_game },
                    { classes: 'px-2 py-4 text-sm text-gray-500 text-center', render: p => p.ict_index.toFixed(1) },
                    { classes: 'px-2 py-4 text-sm text-gray-500 text-center', render: p => p.bps },
                    { classes: 'px-2 py-4 text-center text-xl tooltip', render: p => `<span class="${'status-' + p.status}">${statusMap[p.status] || '❔'}</span>${p.news ? `<span class="tooltiptext">${p.news}</span>` : ''}` }
                ];
                renderPlayers('fpl-players-table-body', filtered, fplSortConfig, columns);
            }
            
            function renderFbrefTable() {
                const columns = [
                    { classes: 'px-3 py-4 whitespace-nowrap', render: p => `<div><div class="font-bold">${p.Player}</div><div class="text-sm text-gray-500">${p.Squad} - ${p.Pos}</div></div>` },
                    { classes: 'px-3 py-4 whitespace-nowrap', render: p => `<div class="flex items-center"><span class="font-semibold w-10">${p.performance_rank.toFixed(1)}</span><div class="w-full bg-gray-200 rounded-full h-2.5 ml-2"><div class="bg-green-600 h-2.5 rounded-full rank-bar" style="width: ${p.performance_rank}%"></div></div></div>` },
                    { classes: 'px-2 py-4 text-sm font-bold text-center', render: p => p.performance_ratio.toFixed(2) },
                    { classes: 'px-2 py-4 text-sm text-gray-500 text-center', render: p => (p.xG + p.xA).toFixed(2) },
                    { classes: 'px-2 py-4 text-sm text-gray-500 text-center', render: p => p.Gls },
                    { classes: 'px-2 py-4 text-sm text-gray-500 text-center', render: p => p.Ast }
                ];
                renderPlayers('fbref-players-table-body', allFbrefPlayers, fbrefSortConfig, columns);
            }

            function renderDraftedList() {
                 // Implementation remains the same
            }
            
            function handleDraft(e) {
                // Implementation remains the same
            }
            
            // --- Initialization ---
            const [fplResult, fbrefResult] = await Promise.all([analyzeFplData(), analyzeFbrefData({pl: GSHEET_PLAYERS_PL, champ: GSHEET_PLAYERS_CHAMP})]);
            
            if (fplResult) {
                allFplPlayers = fplResult.players;
                const fplWeights = fplResult.weights;
                const teamFilter = document.getElementById('team-filter');
                if (teamFilter) {
                    const teams = [...new Set(allFplPlayers.map(p => p.team_name))].sort();
                    teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team;
                        option.textContent = team;
                        teamFilter.appendChild(option);
                    });
                }
            }
            if (fbrefResult) {
                allFbrefPlayers = fbrefResult;
            }

            loader.style.display = 'none';
            mainContent.style.display = 'block';
            render();

            // Event Listeners
            document.getElementById('fpl-players-table-body').addEventListener('click', handleDraft);
            // ... other listeners
        });
    </script>
</body>
</html>
