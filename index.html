<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Live Draft Kit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            direction: rtl;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* [חדש] Sticky header for table */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th {
            cursor: pointer;
        }
        .rank-bar {
             background: linear-gradient(to right, #d1d5db, #6ee7b7, #10b981);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .status-a { color: #16a34a; }
        .status-i { color: #dc2626; }
        .status-d { color: #f59e0b; }
        .status-s { color: #f97316; }
        .status-u { color: #6b7280; }
        
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center;
            border-radius: 6px; padding: 5px 10px; position: absolute; z-index: 1; bottom: 125%;
            left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s;
            font-size: 0.875rem; direction: ltr;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .pitch {
            background-color: #008053;
            border: 2px solid #fff;
            position: relative;
            overflow: hidden;
        }
        .pitch-line { background-color: rgba(255,255,255,0.5); position: absolute; }
        .center-line { width: 2px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); }
        .center-circle { width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .penalty-box { border: 2px solid rgba(255,255,255,0.5); position: absolute; }
        .box-top { height: 100px; width: 60%; top: 0; left: 20%; }
        .box-bottom { height: 100px; width: 60%; bottom: 0; left: 20%; }

        .player-shirt {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            padding: 2px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            position: relative;
            min-width: 64px;
        }
        .toggle-dot {
             transition: transform .3s ease-in-out;
        }
        input:checked ~ .toggle-dot {
            transform: translateX(100%);
            background-color: #48bb78;
        }
        #alert-box {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* [חדש] Colored rank numbers */
        .rank-high { color: #059669; } /* emerald-600 */
        .rank-mid { color: #ca8a04; } /* yellow-600 */
        .rank-low { color: #dc2626; } /* red-600 */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-900">FPL Live Draft Kit</h1>
            <p class="text-lg text-gray-600 mt-2">כלי עזר לבחירת שחקנים בדראפט, מבוסס נתוני FPL API</p>
        </header>
        
        <div id="alert-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform -translate-y-12 z-50">
            <p id="alert-message"></p>
        </div>

        <div id="main-content" class="hidden">
            
            <div class="bg-white p-4 rounded-lg shadow-md mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <input type="text" id="search-player" class="w-full rounded-md border-gray-300 shadow-sm" placeholder="חיפוש שחקן...">
                <select id="team-filter" class="w-full rounded-md border-gray-300 shadow-sm"><option value="all">כל הקבוצות</option></select>
                <select id="position-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                    <option value="all">כל העמדות</option>
                    <option value="GKP">שוערים (GKP)</option>
                    <option value="DEF">הגנה (DEF)</option>
                    <option value="MID">קישור (MID)</option>
                    <option value="FWD">התקפה (FWD)</option>
                </select>
                <select id="status-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                    <option value="all">כל הסטטוסים</option>
                    <option value="a">זמינים</option>
                    <option value="d">בספק</option>
                    <option value="i">פצועים</option>
                </select>
                <div class="flex items-center">
                    <input id="show-new-players-only" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                    <label for="show-new-players-only" class="mr-2 text-sm text-gray-900">רק חדשים</label>
                </div>
                <button id="reset-draft" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">איפוס</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3">
                    <h2 class="text-2xl font-bold mb-4">שחקנים פנויים</h2>
                    <div class="overflow-auto bg-white rounded-lg shadow max-h-[75vh]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500" data-sort="web_name">שחקן</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500" data-sort="fpl_potential_rank">דירוג</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort="points_per_game">נק'/משחק</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort="minutes_per_game">דק'/משחק</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort="selected_by_percent">החזקה</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort="total_points">סה"כ נק'</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500" data-sort="status">סטטוס</th>
                                </tr>
                            </thead>
                            <tbody id="players-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-2">
                     <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-bold">הקבוצה שלי</h2>
                        <div class="text-left">
                            <div class="font-bold text-lg">£<span id="total-cost">0.0</span>m</div>
                            <div class="text-xs text-gray-500">שווי קבוצה</div>
                        </div>
                    </div>
                     <div class="flex justify-between items-center mb-4 bg-gray-200 p-2 rounded-lg">
                        <div id="squad-counts" class="text-xs font-semibold grid grid-cols-4 gap-1 text-center">
                            <div>שוערים: <span id="gkp-count">0</span>/2</div>
                            <div>מגנים: <span id="def-count">0</span>/5</div>
                            <div>קשרים: <span id="mid-count">0</span>/5</div>
                            <div>חלוצים: <span id="fwd-count">0</span>/3</div>
                        </div>
                        <div class="font-bold text-lg"><span id="drafted-count">0</span>/15</div>
                    </div>
                    <div id="pitch" class="pitch h-[500px] p-2 rounded-lg flex flex-col justify-around">
                         <div class="pitch-line center-line"></div>
                         <div class="pitch-line center-circle"></div>
                         <div class="pitch-line penalty-box box-top"></div>
                         <div class="pitch-line penalty-box box-bottom"></div>
                         
                         <div class="relative"><div class="absolute -top-2 right-2 text-white text-xs opacity-70">חלוצים</div><div id="forwards" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                         <div class="relative"><div class="absolute -top-2 right-2 text-white text-xs opacity-70">קשרים</div><div id="midfielders" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                         <div class="relative"><div class="absolute -top-2 right-2 text-white text-xs opacity-70">מגנים</div><div id="defenders" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                         <div class="relative"><div class="absolute -top-2 right-2 text-white text-xs opacity-70">שוערים</div><div id="goalkeepers" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-xl font-bold mb-2 text-center">ספסל</h3>
                        <div id="bench" class="bg-gray-200 p-2 rounded-lg flex justify-center items-center gap-2 flex-wrap min-h-[120px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loader-container" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-50">
        <div class="loader"></div>
        <p class="ml-4 text-lg text-white">טוען נתונים עדכניים...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const CORS_PROXY = `https://corsproxy.io/?`;
            const FPL_API_URL = `${CORS_PROXY}${encodeURIComponent('https://fantasy.premierleague.com/api/bootstrap-static/')}`;
            
            let allPlayers = [];
            let draftedPlayers = JSON.parse(localStorage.getItem('draftedPlayers')) || [];
            let sortConfig = { key: 'fpl_potential_rank', direction: 'desc' };

            const SQUAD_LIMITS = { TOTAL: 15, GKP: 2, DEF: 5, MID: 5, FWD: 3 };

            const loader = document.getElementById('loader-container');
            const mainContent = document.getElementById('main-content');
            mainContent.style.display = 'none';

            async function fetchData() {
                try {
                    const fplRes = await fetch(FPL_API_URL);
                    if (!fplRes.ok) throw new Error('Failed to fetch FPL data');
                    return await fplRes.json();
                } catch (error) {
                    console.error("Error fetching data:", error);
                    loader.innerHTML = '<p class="text-red-500">שגיאה בטעינת הנתונים. נסה לרענן את הדף.</p>';
                    return null;
                }
            }
            
            function analyzeData(fplData) {
                let playersDf = fplData.elements;
                const teamsDf = fplData.teams;
                const positionsDf = fplData.element_types;

                const playerPositionTypes = new Set(positionsDf.filter(p => p.singular_name !== 'Manager').map(p => p.id));
                playersDf = playersDf.filter(p => playerPositionTypes.has(p.element_type));

                const posMap = new Map(positionsDf.map(p => [p.id, p.singular_name_short]));
                const teamMap = new Map(teamsDf.map(t => [t.id, t.name]));
                
                playersDf.forEach(p => {
                    p.position = posMap.get(p.element_type);
                    p.team_name = teamMap.get(p.team);
                    const numericCols = ['ict_index', 'form', 'bps', 'influence', 'creativity', 'threat', 'total_points', 'goals_scored', 'assists', 'clean_sheets', 'minutes', 'points_per_game', 'selected_by_percent', 'now_cost'];
                    numericCols.forEach(col => p[col] = parseFloat(p[col] || 0));
                    const gamesPlayed = p.points_per_game > 0 ? p.total_points / p.points_per_game : 0;
                    p.minutes_per_game = gamesPlayed > 0 ? Math.round(p.minutes / gamesPlayed) : 0;
                });

                function scale(values) {
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    return max === min ? values.map(() => 0.5) : values.map(v => (v - min) / (max - min));
                }
                
                const normalized = {
                    ict: scale(playersDf.map(p => p.ict_index)),
                    bps: scale(playersDf.map(p => p.bps))
                };

                const weights = {
                    'GKP': {'ict': 0.7, 'bps': 0.3},
                    'DEF': {'ict': 0.8, 'bps': 0.2},
                    'MID': {'ict': 0.85, 'bps': 0.15},
                    'FWD': {'ict': 0.9, 'bps': 0.1}
                };

                playersDf.forEach((p, i) => {
                    let rank = 0;
                    const posWeights = weights[p.position];
                    if (posWeights) {
                        for (const [metric, weight] of Object.entries(posWeights)) {
                            rank += (normalized[metric][i] || 0) * weight;
                        }
                    }
                    p.fpl_potential_rank = rank * 100;
                });
                
                return playersDf;
            }

            function render() {
                renderPlayersTable();
                renderDraftedList();
            }

            function renderPlayersTable() {
                const tableBody = document.getElementById('players-table-body');
                const searchFilter = document.getElementById('search-player').value.toLowerCase();
                const positionFilter = document.getElementById('position-filter').value;
                const statusFilter = document.getElementById('status-filter').value;
                const teamFilter = document.getElementById('team-filter').value;
                const showNewPlayersOnly = document.getElementById('show-new-players-only').checked;

                let filteredPlayers = allPlayers.filter(p => !draftedPlayers.includes(p.id));

                if (showNewPlayersOnly) {
                    filteredPlayers = filteredPlayers.filter(p => p.minutes === 0);
                }
                if (searchFilter) {
                    filteredPlayers = filteredPlayers.filter(p => p.web_name.toLowerCase().includes(searchFilter) || p.team_name.toLowerCase().includes(searchFilter));
                }
                if (positionFilter !== 'all') {
                    filteredPlayers = filteredPlayers.filter(p => p.position === positionFilter);
                }
                if (statusFilter !== 'all') {
                    filteredPlayers = filteredPlayers.filter(p => p.status === statusFilter);
                }
                if (teamFilter !== 'all') {
                    filteredPlayers = filteredPlayers.filter(p => p.team_name === teamFilter);
                }

                filteredPlayers.sort((a, b) => {
                    const valA = a[sortConfig.key];
                    const valB = b[sortConfig.key];
                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                const statusMap = {
                    'a': { icon: '✅', title: 'זמין', class: 'status-a' },
                    'd': { icon: '❓', title: 'בספק', class: 'status-d' },
                    'i': { icon: '🚑', title: 'פצוע', class: 'status-i' },
                    's': { icon: '🟥', title: 'מושעה', class: 'status-s' },
                    'u': { icon: '❔', title: 'לא ידוע', class: 'status-u' }
                };
                
                const getRankColor = (rank) => {
                    if (rank > 66) return 'rank-high';
                    if (rank > 33) return 'rank-mid';
                    return 'rank-low';
                };

                tableBody.innerHTML = filteredPlayers.map(p => `
                    <tr>
                        <td class="px-3 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <button class="draft-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md transition ml-3" data-id="${p.id}">בחר</button>
                                <div>
                                    <div class="font-bold">${p.web_name}</div>
                                    <div class="text-sm text-gray-500">${p.team_name} - £${(p.now_cost / 10).toFixed(1)}m</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="font-semibold w-12 text-center ${getRankColor(p.fpl_potential_rank)}">${p.fpl_potential_rank.toFixed(1)}</span>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 ml-2"><div class="bg-green-600 h-2.5 rounded-full rank-bar" style="width: ${p.fpl_potential_rank}%"></div></div>
                            </div>
                        </td>
                        <td class="px-2 py-4 text-sm font-bold text-center">${p.points_per_game}</td>
                        <td class="px-2 py-4 text-sm text-gray-500 text-center">${p.minutes_per_game}</td>
                        <td class="px-2 py-4 text-sm text-gray-500 text-center">${p.selected_by_percent}%</td>
                        <td class="px-2 py-4 text-sm text-gray-500 text-center">${p.total_points}</td>
                        <td class="px-2 py-4 text-sm text-gray-500 text-center">${p.goals_scored}</td>
                        <td class="px-2 py-4 text-sm text-gray-500 text-center">${p.assists}</td>
                        <td class="px-2 py-4 text-sm text-gray-500 text-center">${p.clean_sheets}</td>
                        <td class="px-2 py-4 text-center text-xl tooltip">
                            <span class="${statusMap[p.status]?.class || 'status-u'}">${statusMap[p.status]?.icon || '❔'}</span>
                            ${p.news ? `<span class="tooltiptext">${p.news}</span>` : ''}
                        </td>
                    </tr>
                `).join('');
            }
            
            function renderDraftedList() {
                const draftedPlayerObjects = draftedPlayers.map(id => allPlayers.find(p => p.id === id)).filter(Boolean);
                
                document.getElementById('drafted-count').textContent = draftedPlayerObjects.length;
                
                const positions = { 'GKP': [], 'DEF': [], 'MID': [], 'FWD': [] };
                let totalCost = 0;
                draftedPlayerObjects.forEach(p => {
                    positions[p.position].push(p);
                    totalCost += p.now_cost;
                });
                
                document.getElementById('total-cost').textContent = (totalCost / 10).toFixed(1);
                
                document.getElementById('gkp-count').textContent = `${positions.GKP.length}`;
                document.getElementById('def-count').textContent = `${positions.DEF.length}`;
                document.getElementById('mid-count').textContent = `${positions.MID.length}`;
                document.getElementById('fwd-count').textContent = `${positions.FWD.length}`;

                const pitchContainers = {
                    'GKP': document.getElementById('goalkeepers'),
                    'DEF': document.getElementById('defenders'),
                    'MID': document.getElementById('midfielders'),
                    'FWD': document.getElementById('forwards')
                };
                const benchContainer = document.getElementById('bench');
                Object.values(pitchContainers).forEach(el => el.innerHTML = '');
                benchContainer.innerHTML = '';

                const bench = [];
                const startingXI = { 'GKP': [], 'DEF': [], 'MID': [], 'FWD': [] };

                startingXI.GKP = positions.GKP.slice(0, 1);
                bench.push(...positions.GKP.slice(1));
                
                startingXI.DEF = positions.DEF.slice(0, 5);
                bench.push(...positions.DEF.slice(5));

                startingXI.MID = positions.MID.slice(0, 5);
                bench.push(...positions.MID.slice(5));

                startingXI.FWD = positions.FWD.slice(0, 3);
                bench.push(...positions.FWD.slice(3));

                function renderPlayerShirt(p) {
                    const shirtColor = p.team_name === 'Arsenal' ? 'bg-red-500' : p.team_name === 'Man City' ? 'bg-sky-400' : p.team_name === 'Liverpool' ? 'bg-red-600' : 'bg-gray-700';
                    const textColor = p.team_name === 'Man City' ? 'text-black' : 'text-white';
                    return `
                        <div class="player-shirt w-20 h-24 ${shirtColor} ${textColor} text-xs font-bold undraft-btn" data-id="${p.id}">
                            <span class="font-bold text-sm">${p.web_name}</span>
                            <span class="text-xs opacity-80">${p.position}</span>
                            <span class="text-lg mt-1">£${(p.now_cost / 10).toFixed(1)}</span>
                        </div>
                    `;
                }

                Object.entries(startingXI).forEach(([pos, players]) => {
                    pitchContainers[pos].innerHTML = players.map(renderPlayerShirt).join('');
                });

                benchContainer.innerHTML = bench.map(renderPlayerShirt).join('');
            }
            
            function showAlert(message) {
                const alertBox = document.getElementById('alert-box');
                const alertMessage = document.getElementById('alert-message');
                alertMessage.textContent = message;
                alertBox.classList.remove('opacity-0', '-translate-y-12');
                alertBox.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    alertBox.classList.remove('opacity-100', 'translate-y-0');
                    alertBox.classList.add('opacity-0', '-translate-y-12');
                }, 3000);
            }

            function handleDraft(e) {
                if (!e.target.classList.contains('draft-btn')) return;
                const playerId = parseInt(e.target.dataset.id);
                const player = allPlayers.find(p => p.id === playerId);
                if (!player) return;

                const draftedPlayerObjects = draftedPlayers.map(id => allPlayers.find(p => p.id === id)).filter(Boolean);
                
                if(draftedPlayerObjects.length >= SQUAD_LIMITS.TOTAL) {
                    showAlert(`הגעת למכסה המקסימלית של ${SQUAD_LIMITS.TOTAL} שחקנים.`);
                    return;
                }
                const positionCount = draftedPlayerObjects.filter(p => p.position === player.position).length;
                if(positionCount >= SQUAD_LIMITS[player.position]) {
                    showAlert(`הגעת למכסה המקסימלית של ${SQUAD_LIMITS[player.position]} שחקנים בעמדת ${player.position}.`);
                    return;
                }

                if (!draftedPlayers.includes(playerId)) {
                    draftedPlayers.push(playerId);
                    localStorage.setItem('draftedPlayers', JSON.stringify(draftedPlayers));
                    render();
                }
            }
            
            function handleUndraft(e) {
                const target = e.target.closest('.undraft-btn');
                if (!target) return;
                const playerId = parseInt(target.dataset.id);
                draftedPlayers = draftedPlayers.filter(id => id !== playerId);
                localStorage.setItem('draftedPlayers', JSON.stringify(draftedPlayers));
                render();
            }

            function handleSort(e) {
                if (e.target.tagName !== 'TH' || !e.target.dataset.sort) return;
                const key = e.target.dataset.sort;
                sortConfig.key = key;
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                renderPlayersTable();
            }
            
            const data = await fetchData();
            if (data) {
                allPlayers = analyzeData(data);
                
                // Populate team filter
                const teamFilter = document.getElementById('team-filter');
                const teams = [...new Set(allPlayers.map(p => p.team_name))].sort();
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamFilter.appendChild(option);
                });

                loader.style.display = 'none';
                mainContent.style.display = 'block';
                render();
            }

            document.getElementById('players-table-body').addEventListener('click', handleDraft);
            document.getElementById('pitch').addEventListener('click', handleUndraft);
            document.getElementById('bench').addEventListener('click', handleUndraft);
            document.querySelector('thead').addEventListener('click', handleSort);
            document.getElementById('search-player').addEventListener('input', renderPlayersTable);
            document.getElementById('position-filter').addEventListener('change', renderPlayersTable);
            document.getElementById('show-new-players-only').addEventListener('change', renderPlayersTable);
            document.getElementById('status-filter').addEventListener('change', renderPlayersTable);
            document.getElementById('team-filter').addEventListener('change', renderPlayersTable);
            document.getElementById('reset-draft').addEventListener('click', () => {
                if(confirm('האם אתה בטוח שברצונך לאפס את הדראפט? כל השחקנים שנבחרו יימחקו.')) {
                    draftedPlayers = [];
                    localStorage.removeItem('draftedPlayers');
                    render();
                }
            });
        });
    </script>
</body>
</html>
