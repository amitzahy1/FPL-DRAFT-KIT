<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Draft Kit - V8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f3f4f6;
        }
        th {
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            background-color: #f9fafb;
        }
        td {
            white-space: nowrap;
        }
        .rank-bar-container {
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.65rem;
            width: 100%;
            overflow: hidden;
        }
        .rank-bar {
            background: linear-gradient(to left, #34d399, #10b981);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .pitch {
            background-color: #22c55e;
            border: 2px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
            background-image:
                linear-gradient(to bottom, transparent 49.5%, rgba(255,255,255,0.3) 49.5%, rgba(255,255,255,0.3) 50.5%, transparent 50.5%);
        }
        .pitch-circle {
            width: 90px;
            height: 90px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .penalty-box {
            border: 2px solid rgba(255,255,255,0.3);
            position: absolute;
            width: 65%;
            left: 17.5%;
        }
        .penalty-box-top { height: 80px; top: 0; border-top: none; }
        .penalty-box-bottom { height: 80px; bottom: 0; border-bottom: none; }
        .player-shirt {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            padding: 2px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            position: relative;
            min-width: 64px;
            transition: transform 0.2s ease-in-out;
        }
        .player-shirt:hover { transform: scale(1.05); }
        #alert-box { transition: opacity 0.5s, transform 0.5s; }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip { position: relative; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 320px;
            background-color: #1f2937;
            color: #fff;
            text-align: right;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 20;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .tooltip-title {
            font-weight: 700;
            color: #a5f3fc;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #374151;
        }
        .top-metrics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #374151;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .metric-name { color: #d1d5db; }
        .metric-weight { font-weight: 600; color: #34d399; }
        .positive-diff { color: #22c55e; font-weight: bold; }
        .negative-diff { color: #ef4444; font-weight: bold; }
        .watchlist-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0.25rem;
            line-height: 1;
            color: #d1d5db;
            transition: transform 0.2s, color 0.2s;
        }
        .watchlist-btn:hover {
            transform: scale(1.2);
            color: #f59e0b;
        }
        .watchlist-btn.added {
            color: #f59e0b;
        }
        #watchlist .stat-label {
            font-size: 0.7rem;
            color: #6b7280;
        }
    </style>
</head>
<body>

    <!-- File Uploader Screen -->
    <div id="upload-container" class="min-h-screen flex flex-col justify-center items-center text-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-2xl w-full">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">FPL Draft Kit</h1>
            <p class="text-gray-600 mb-8">×›×“×™ ×œ×”×ª×—×™×œ, ×× × ×”×¢×œ×” ××ª ×©× ×™ ×§×‘×¦×™ ×”× ×ª×•× ×™×.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex flex-col items-center p-6 border-2 border-dashed rounded-lg">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">1. × ×ª×•× ×™ ×¤×¨××™×™×¨ ×œ×™×’</h2>
                    <label for="fpl-file-input" class="w-full inline-block bg-blue-500 text-white font-bold py-2 px-4 rounded-lg cursor-pointer hover:bg-blue-600 transition">
                        ×‘×—×¨ ×§×•×‘×¥ FPL
                    </label>
                    <input type="file" id="fpl-file-input" class="hidden" accept=".json,application/json">
                    <p id="fpl-file-name" class="mt-3 text-sm text-gray-500 h-5"></p>
                </div>
                <div class="flex flex-col items-center p-6 border-2 border-dashed rounded-lg">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">2. × ×ª×•× ×™ ×¦'××¤×™×•× ×©×™×¤</h2>
                    <label for="champ-file-input" class="w-full inline-block bg-green-500 text-white font-bold py-2 px-4 rounded-lg cursor-pointer hover:bg-green-600 transition">
                        ×‘×—×¨ ×§×•×‘×¥ ×¦'××¤×™×•× ×©×™×¤
                    </label>
                    <input type="file" id="champ-file-input" class="hidden" accept=".json,application/json">
                    <p id="champ-file-name" class="mt-3 text-sm text-gray-500 h-5"></p>
                </div>
            </div>
            <button id="start-analysis-btn" class="mt-8 w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg cursor-not-allowed" disabled>
                ×”×ª×—×œ × ×™×ª×•×—
            </button>
        </div>
    </div>

    <!-- Loader Screen -->
    <div id="loader-container" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p id="loader-text" class="mt-4 text-lg text-white">××¢×‘×“ × ×ª×•× ×™×...</p>
    </div>

    <!-- Main Application (initially hidden) -->
    <div id="app" class="container mx-auto p-4 hidden">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-900">FPL Draft Kit</h1>
            <p class="text-lg text-gray-600 mt-2">×›×œ×™ ×”×“×¨××¤×˜ ×”××•×œ×˜×™××˜×™×‘×™, ××‘×•×¡×¡ × ×ª×•× ×™ FPL ×•×¦'××¤×™×•× ×©×™×¤</p>
        </header>
        
        <div id="alert-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform -translate-y-12 z-50">
            <p id="alert-message"></p>
        </div>
        
        <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                <h3 class="text-lg font-bold mb-4" id="confirm-modal-title">××™×©×•×¨ ×¤×¢×•×œ×”</h3>
                <p id="confirm-modal-body">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×”×§×‘×•×¦×”?</p>
                <div class="mt-6 flex justify-center gap-4">
                    <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">×‘×™×˜×•×œ</button>
                    <button id="modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">××¤×¡ ×§×‘×•×¦×”</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-3 space-y-8">
                <!-- Unified Table Section -->
                <div>
                    <h2 class="text-2xl font-bold mb-2">×××’×¨ ×©×—×§× ×™× ×××•×—×“</h2>
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="text" id="name-filter" class="w-full rounded-md border-gray-300 shadow-sm" placeholder="×—×™×¤×•×© ×©× ×©×—×§×Ÿ...">
                        <select id="position-filter" class="w-full rounded-md border-gray-300 shadow-sm"></select>
                        <select id="team-filter" class="w-full rounded-md border-gray-300 shadow-sm"></select>
                        <select id="status-filter" class="w-full rounded-md border-gray-300 shadow-sm"></select>
                        <div class="col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="price-filter" class="block text-sm font-medium text-gray-700">××—×™×¨ ××§×¡×™××œ×™: <span id="price-value" class="font-bold"></span></label>
                                <input type="range" id="price-filter" min="3.5" max="14.0" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="points-filter" class="block text-sm font-medium text-gray-700">××™× ×™××•× × ×§×•×“×•×ª: <span id="points-value" class="font-bold"></span></label>
                                <input type="range" id="points-filter" min="0" max="300" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow max-h-[70vh]">
                        <table id="players-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th data-sort="web_name">×©×—×§×Ÿ</th>
                                    <th data-sort="player_rank">FPL Rank</th>
                                    <th data-sort="total_points">× ×§×•×“×•×ª</th>
                                    <th data-sort="selected_by_percent">××—×•×– ×‘×¢×œ×•×ª</th>
                                    <th data-sort="now_cost">××—×™×¨</th>
                                    <th data-sort="expected_goal_involvements">xGi</th>
                                    <th data-sort="xgi_performance">xGi Perf</th>
                                    <th data-sort="goals_scored">×©×¢×¨×™×</th>
                                    <th data-sort="assists">×‘×™×©×•×œ×™×</th>
                                    <th data-sort="ict_index">ICT</th>
                                    <th data-sort="status">×¡×˜×˜×•×¡</th>
                                </tr>
                            </thead>
                            <tbody id="players-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="sticky top-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-bold">×”×§×‘×•×¦×” ×©×œ×™</h2>
                        <button id="reset-squad-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md transition text-sm">××¤×¡ ×§×‘×•×¦×”</button>
                    </div>
                    <div class="flex justify-between items-center my-4 bg-white p-3 rounded-lg shadow">
                        <div id="squad-counts" class="text-xs font-semibold grid grid-cols-4 gap-2 text-center">
                            <div>×©×•×¢×¨×™×: <span id="gkp-count" class="font-bold">0</span>/2</div>
                            <div>××’× ×™×: <span id="def-count" class="font-bold">0</span>/5</div>
                            <div>×§×©×¨×™×: <span id="mid-count" class="font-bold">0</span>/5</div>
                            <div>×—×œ×•×¦×™×: <span id="fwd-count" class="font-bold">0</span>/3</div>
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-lg">Â£<span id="total-cost">0.0</span>m</div>
                            <div class="text-xs text-gray-500"><span id="drafted-count">0</span>/15 ×©×—×§× ×™×</div>
                        </div>
                    </div>
                    <div id="pitch" class="pitch h-[450px] p-2 rounded-lg flex flex-col justify-around shadow-inner">
                        <div class="pitch-circle"></div>
                        <div class="penalty-box penalty-box-top"></div>
                        <div class="penalty-box penalty-box-bottom"></div>
                        <div class="relative"><div id="forwards" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                        <div class="relative"><div id="midfielders" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                        <div class="relative"><div id="defenders" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                        <div class="relative"><div id="goalkeepers" class="h-full flex justify-center items-center gap-2 flex-wrap"></div></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-xl font-bold mb-2 text-center">×¡×¤×¡×œ</h3>
                        <div id="bench" class="bg-gray-200 p-2 rounded-lg flex justify-center items-center gap-2 flex-wrap min-h-[70px] shadow-inner"></div>
                    </div>
                     <!-- Watchlist Section -->
                    <div class="mt-4">
                        <h3 class="text-xl font-bold mb-2 text-center">Watchlist</h3>
                        <div id="watchlist" class="bg-white rounded-lg shadow min-h-[100px] max-h-48 overflow-y-auto">
                            <!-- Watchlist players will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        let allPlayersData = [];
        let fplData = null, champData = null;

        const uploadContainer = document.getElementById('upload-container');
        const loader = document.getElementById('loader-container');
        const app = document.getElementById('app');
        
        const fplFileInput = document.getElementById('fpl-file-input');
        const fplFileNameEl = document.getElementById('fpl-file-name');
        const champFileInput = document.getElementById('champ-file-input');
        const champFileNameEl = document.getElementById('champ-file-name');
        const startAnalysisBtn = document.getElementById('start-analysis-btn');

        const rankingWeights = {
            GKP: { total_points: 8, xGc_performance: 10, clean_sheets: 6, penalties_saved: 5, saves: 4 },
            DEF: { total_points: 10, expected_goal_involvements: 8, clean_sheets: 7, xGc_performance: 3, goals_scored: 4, assists: 4 },
            MID: { total_points: 10, expected_goal_involvements: 9, xgi_performance: 6, ict_index: 5, threat: 5, actual_goal_involvements: 4 },
            FWD: { total_points: 10, expected_goal_involvements: 9, xgi_performance: 7, threat: 6, actual_goal_involvements: 5, ict_index: 4 }
        };

        function readFileAsJson(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { resolve(JSON.parse(e.target.result)); } 
                    catch (error) { reject(new Error(`×©×’×™××” ×‘×¤×¢× ×•×— ×”×§×•×‘×¥: ${file.name}`)); }
                };
                reader.onerror = () => reject(new Error(`×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: ${file.name}`));
                reader.readAsText(file);
            });
        }

        function checkCanStart() {
            if (fplData && champData) {
                startAnalysisBtn.disabled = false;
                startAnalysisBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                startAnalysisBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        fplFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            fplFileNameEl.textContent = '×˜×•×¢×Ÿ...';
            try {
                const data = await readFileAsJson(file);
                if (!data.elements || !data.teams) throw new Error("×¤×•×¨××˜ FPL ×œ× ×ª×§×™×Ÿ");
                fplData = data;
                fplFileNameEl.textContent = `âœ”ï¸ ${file.name}`;
                checkCanStart();
            } catch (error) {
                alert(error.message);
                fplFileNameEl.textContent = '';
                fplData = null;
            }
        });

        champFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            champFileNameEl.textContent = '×˜×•×¢×Ÿ...';
            try {
                const data = await readFileAsJson(file);
                if (!data.elements || !data.teams) throw new Error("×¤×•×¨××˜ ×¦'××¤×™×•× ×©×™×¤ ×œ× ×ª×§×™×Ÿ");
                champData = data;
                champFileNameEl.textContent = `âœ”ï¸ ${file.name}`;
                checkCanStart();
            } catch (error) {
                alert(error.message);
                champFileNameEl.textContent = '';
                champData = null;
            }
        });

        startAnalysisBtn.addEventListener('click', () => {
            uploadContainer.classList.add('hidden');
            loader.classList.remove('hidden');
            const mergedData = {
                ...fplData,
                elements: [...fplData.elements, ...champData.elements],
                teams: [...fplData.teams, ...champData.teams],
                element_types: fplData.element_types
            };
            setTimeout(() => startApp(mergedData), 500);
        });

        function processPlayerData(data) {
            if (!data || !data.teams || !data.element_types) {
                console.error("Invalid data passed to processPlayerData:", data);
                return [];
            }
            const teamsMap = new Map(data.teams.map(t => [t.id, t.name]));
            const posMap = new Map(data.element_types.map(p => [p.id, p.singular_name_short]));
            
            return data.elements.map(p => {
                const xgi = parseFloat(p.expected_goal_involvements) || 0;
                const actual_gi = (p.goals_scored || 0) + (p.assists || 0);
                const xgc = parseFloat(p.expected_goals_conceded) || 0;
                const actual_gc = p.goals_conceded || 0;

                return { 
                    ...p, 
                    team_name: teamsMap.get(p.team), 
                    position: posMap.get(p.element_type),
                    xgi_performance: (xgi - actual_gi),
                    xGc_performance: (xgc - actual_gc),
                    actual_goal_involvements: actual_gi
                }
            });
        }

        function scaleValues(data, key) {
            const values = data.map(p => parseFloat(p[key])).filter(v => !isNaN(v));
            if (values.length === 0) return data.map(() => 0);
            const min = Math.min(...values);
            const max = Math.max(...values);
            if (max === min) return data.map(p => isNaN(parseFloat(p[key])) ? 0 : 0.5);
            return data.map(p => isNaN(parseFloat(p[key])) ? 0 : (parseFloat(p[key]) - min) / (max - min));
        }

        function calculateRanks(players) {
            const metricsToNormalize = new Set();
            Object.values(rankingWeights).forEach(posWeights => Object.keys(posWeights).forEach(metric => metricsToNormalize.add(metric)));
            
            const normalized = {};
            metricsToNormalize.forEach(metric => {
                normalized[metric] = scaleValues(players, metric);
            });

            players.forEach((player, index) => {
                let totalWeight = 0;
                let weightedScore = 0;
                const weights = rankingWeights[player.position];
                player.rank_breakdown = [];

                if (weights) {
                    for (const [metric, weight] of Object.entries(weights)) {
                         if (normalized[metric] && normalized[metric][index] !== undefined) {
                            const metricScore = normalized[metric][index] * weight;
                            weightedScore += metricScore;
                            totalWeight += Math.abs(weight);
                            player.rank_breakdown.push({ metric, score: metricScore, weight, raw_value: player[metric] });
                        }
                    }
                }
                player.player_rank = totalWeight > 0 ? (weightedScore / totalWeight) * 100 : 0;
                player.player_rank = Math.max(0, player.player_rank);

                player.rank_breakdown.sort((a, b) => Math.abs(b.score) - Math.abs(a.score));
            });
        }
        
        function generateRankTooltip(player) {
            if (!player.rank_breakdown) return '';
            const topMetrics = player.rank_breakdown.slice(0, 3);
            let metricsHtml = topMetrics.map(item => {
                let metricName = item.metric.replace(/_/g, ' ');
                let rawValue = item.raw_value;
                if (typeof rawValue === 'number' && !Number.isInteger(rawValue)) {
                    rawValue = rawValue.toFixed(2);
                }
                return `<div class="metric-item">
                          <span class="metric-name">${metricName} (${rawValue})</span>
                          <span class="metric-weight">×ª×¨×•××”: ${item.score.toFixed(1)}</span>
                        </div>`;
            }).join('');
            return `<div class="tooltip-title">××“×“×™× ××•×‘×™×œ×™× ×œ×“×™×¨×•×’</div><div class="top-metrics-grid">${metricsHtml}</div>`;
        }

        let draftedPlayers = new Map(JSON.parse(localStorage.getItem('fplDraftKit_v8_draft')));
        let watchlistPlayers = new Map(JSON.parse(localStorage.getItem('fplDraftKit_v8_watchlist')));
        let sortConfig = { key: 'player_rank', direction: 'desc' };
        const SQUAD_LIMITS = { TOTAL: 15, GKP: 2, DEF: 5, MID: 5, FWD: 3 };
        const modalEl = document.getElementById('confirm-modal');

        function setupFilters(dataSet) {
            const playerPositions = ['GKP', 'DEF', 'MID', 'FWD'];
            const positions = [...new Set(dataSet.map(p => p.position))].filter(p => playerPositions.includes(p)).sort();
            const teams = [...new Set(dataSet.map(p => p.team_name))].filter(Boolean).sort();
            
            const posEl = document.getElementById(`position-filter`);
            const teamEl = document.getElementById(`team-filter`);
            const statusEl = document.getElementById(`status-filter`);
            const priceEl = document.getElementById(`price-filter`);
            const priceValEl = document.getElementById(`price-value`);
            const pointsEl = document.getElementById(`points-filter`);
            const pointsValEl = document.getElementById(`points-value`);

            posEl.innerHTML = '<option value="">×›×œ ×”×¢××“×•×ª</option>' + positions.map(p => `<option value="${p}">${p}</option>`).join('');
            teamEl.innerHTML = '<option value="">×›×œ ×”×§×‘×•×¦×•×ª</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
            statusEl.innerHTML = `<option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option><option value="a">×–××™× ×™×</option><option value="d">×‘×¡×¤×§</option><option value="i">×¤×¦×•×¢×™×</option><option value="u">×œ× ×–××™× ×™×</option>`;
            
            priceEl.value = priceEl.max;
            priceValEl.textContent = `Â£${priceEl.value}m`;
            pointsEl.value = pointsEl.min;
            pointsValEl.textContent = pointsEl.value;
        }
        
        function sortData(data, config) {
            data.sort((a, b) => {
                let valA = a[config.key], valB = b[config.key];
                if (typeof valA === 'string') {
                    const numA = parseFloat(valA), numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) return config.direction === 'asc' ? numA - numB : numB - numA;
                    return config.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                if (valA === null || valA === undefined) valA = -Infinity;
                if (valB === null || valB === undefined) valB = -Infinity;
                return config.direction === 'asc' ? parseFloat(valA) - parseFloat(valB) : parseFloat(valB) - parseFloat(valA);
            });
        }

        function renderTable() {
            const nameFilter = document.getElementById(`name-filter`).value.toLowerCase();
            const posFilter = document.getElementById(`position-filter`).value;
            const teamFilter = document.getElementById(`team-filter`).value;
            const statusFilter = document.getElementById(`status-filter`).value;
            const priceFilter = parseFloat(document.getElementById(`price-filter`).value);
            const pointsFilter = parseInt(document.getElementById(`points-filter`).value);
            
            document.getElementById(`price-value`).textContent = `Â£${priceFilter}m`;
            document.getElementById(`points-value`).textContent = pointsFilter;

            let filteredData = allPlayersData.filter(p => {
                if (draftedPlayers.has(p.id)) return false;
                return p.web_name.toLowerCase().includes(nameFilter) &&
                       (!posFilter || p.position === posFilter) &&
                       (!teamFilter || p.team_name === teamFilter) &&
                       (!statusFilter || p.status === statusFilter) &&
                       (p.now_cost / 10) <= priceFilter &&
                       p.total_points >= pointsFilter;
            });

            sortData(filteredData, sortConfig);

            const statusMap = { 'a': 'âœ…', 'd': 'â“', 'i': 'ğŸš‘', 'u': 'âŒ', 'n': 'âŒ' };
            const tableBodyHTML = filteredData.map(p => {
                const xgiPerf = parseFloat(p.xgi_performance);
                const perfClass = xgiPerf < 0 ? 'positive-diff' : (xgiPerf > 0 ? 'negative-diff' : '');
                const xgiPerfDisplay = (xgiPerf > 0 ? '+' : '') + xgiPerf.toFixed(2);
                const isWatched = watchlistPlayers.has(p.id);

                return `
                <tr class="hover:bg-gray-50 transition-colors duration-200">
                    <td class="px-3 py-2"><div class="flex items-center"><button class="draft-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded-md transition ml-2 text-sm" data-id="${p.id}">×‘×—×¨</button><button class="watchlist-btn ${isWatched ? 'added' : ''}" data-id="${p.id}" title="×”×•×¡×£ ×œ××¢×§×‘">â­</button><div><div class="font-bold ml-2">${p.web_name}</div><div class="text-xs text-gray-500 ml-2">${p.team_name} - ${p.position}</div></div></div></td>
                    <td class="px-3 py-2 tooltip"><div class="flex items-center"><span class="font-semibold w-10">${(p.player_rank || 0).toFixed(1)}</span><div class="w-full rank-bar-container ml-2"><div class="rank-bar" style="width: ${p.player_rank || 0}%"></div></div></div><div class="tooltiptext">${generateRankTooltip(p)}</div></td>
                    <td class="px-2 py-2 text-sm text-center font-bold">${p.total_points || 0}</td>
                    <td class="px-2 py-2 text-sm text-center">${p.selected_by_percent}%</td>
                    <td class="px-2 py-2 text-sm text-center font-semibold">Â£${(p.now_cost / 10).toFixed(1)}m</td>
                    <td class="px-2 py-2 text-sm text-center text-gray-600">${parseFloat(p.expected_goal_involvements || 0).toFixed(2)}</td>
                    <td class="px-2 py-2 text-sm text-center ${perfClass}">${xgiPerfDisplay}</td>
                    <td class="px-2 py-2 text-sm text-center text-gray-600">${p.goals_scored || 0}</td>
                    <td class="px-2 py-2 text-sm text-center text-gray-600">${p.assists || 0}</td>
                    <td class="px-2 py-2 text-sm text-center">${p.ict_index}</td>
                    <td class="px-2 py-2 text-sm text-center text-2xl" title="${p.news || '××™×Ÿ ×—×“×©×•×ª'}">${statusMap[p.status] || 'â“'}</td>
                </tr>`;
            }).join('');
            document.getElementById(`players-table-body`).innerHTML = tableBodyHTML;
        }

        function renderSquad() {
            const positions = { GKP: [], DEF: [], MID: [], FWD: [] };
            let totalCost = 0;
            draftedPlayers.forEach(id => {
                const player = allPlayersData.find(p => p.id === id);
                if (player) {
                    positions[player.position].push(player);
                    totalCost += player.now_cost / 10;
                }
            });

            document.getElementById('goalkeepers').innerHTML = positions.GKP.map(p => createPlayerShirt(p)).join('');
            document.getElementById('defenders').innerHTML = positions.DEF.map(p => createPlayerShirt(p)).join('');
            document.getElementById('midfielders').innerHTML = positions.MID.map(p => createPlayerShirt(p)).join('');
            document.getElementById('forwards').innerHTML = positions.FWD.map(p => createPlayerShirt(p)).join('');
            document.getElementById('bench').innerHTML = '';

            document.getElementById('total-cost').textContent = totalCost.toFixed(1);
            document.getElementById('drafted-count').textContent = draftedPlayers.size;
            document.getElementById('gkp-count').textContent = positions.GKP.length;
            document.getElementById('def-count').textContent = positions.DEF.length;
            document.getElementById('mid-count').textContent = positions.MID.length;
            document.getElementById('fwd-count').textContent = positions.FWD.length;
        }

        function renderWatchlist() {
            const watchlistEl = document.getElementById('watchlist');
            if (watchlistPlayers.size === 0) {
                watchlistEl.innerHTML = `<p class="text-center text-gray-500 p-4">×¨×©×™××ª ×”××¢×§×‘ ×©×œ×š ×¨×™×§×”.</p>`;
                return;
            }

            let html = '<div class="divide-y divide-gray-200">';
            watchlistPlayers.forEach(id => {
                const player = allPlayersData.find(p => p.id === id);
                if (player) {
                    html += `
                    <div class="p-2 flex items-center justify-between hover:bg-gray-50">
                        <div class="w-1/3">
                            <div class="font-bold text-sm truncate">${player.web_name}</div>
                            <div class="text-xs text-gray-500 truncate">${player.team_name}</div>
                        </div>
                        <div class="w-1/2 flex justify-around text-xs text-center">
                            <div><div class="font-bold">${player.player_rank.toFixed(1)}</div><div class="stat-label">Rank</div></div>
                            <div><div class="font-bold">${player.selected_by_percent}%</div><div class="stat-label">Own%</div></div>
                            <div><div class="font-bold">Â£${(player.now_cost / 10).toFixed(1)}</div><div class="stat-label">Price</div></div>
                            <div><div class="font-bold">${player.points_per_game}</div><div class="stat-label">PPG</div></div>
                        </div>
                        <div class="w-1/6 flex items-center justify-end gap-2">
                            <button class="draft-from-watchlist-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded" data-id="${player.id}" title="×‘×—×¨ ×œ×§×‘×•×¦×”">âœ”ï¸</button>
                            <button class="remove-from-watchlist-btn text-red-500 hover:text-red-700 text-xl font-bold" data-id="${player.id}" title="×”×¡×¨ ××”×¨×©×™××”">&times;</button>
                        </div>
                    </div>`;
                }
            });
            html += '</div>';
            watchlistEl.innerHTML = html;
        }

        function createPlayerShirt(player) {
            const teamColors = {'Man City':'bg-sky-300','Liverpool':'bg-red-500 text-white','Arsenal':'bg-red-600 text-white','Newcastle':'bg-gray-800 text-white','Aston Villa':'bg-purple-900 text-yellow-300','Man Utd':'bg-red-600 text-white','Brighton':'bg-blue-500 text-white','Brentford':'bg-red-500 text-white','Tottenham':'bg-gray-100 text-blue-900','Spurs':'bg-gray-100 text-blue-900','Chelsea':'bg-blue-700 text-white','West Ham':'bg-purple-800 text-sky-300','Everton':'bg-blue-800 text-white', 'Leicester': 'bg-blue-600 text-white', 'Ipswich': 'bg-blue-700 text-white', 'Southampton': 'bg-red-600 text-white', 'Nott\'m Forest': 'bg-red-600 text-white', 'Fulham': 'bg-gray-100 text-black border border-gray-400', 'Wolves': 'bg-yellow-500 text-black', 'Crystal Palace': 'bg-blue-700 text-red-600', 'Bournemouth': 'bg-red-600 text-black', 'Leeds United': 'bg-yellow-300 text-blue-800', 'Burnley': 'bg-red-800 text-sky-300', 'Sunderland': 'bg-red-600 text-white'};
            const colorClass = teamColors[player.team_name] || 'bg-gray-200';
            return `<div class="player-shirt ${colorClass} undraft-btn" data-id="${player.id}" title="×œ×—×¥ ×œ×”×¡×¨×”"><div class="font-bold text-sm truncate">${player.web_name}</div><div class="text-xs">Â£${(player.now_cost / 10).toFixed(1)}m</div></div>`;
        }
        
        function handleDraft(id) {
            const player = allPlayersData.find(p => p.id === id);
            if (!player) return;
            const currentCounts = { GKP: 0, DEF: 0, MID: 0, FWD: 0 };
            draftedPlayers.forEach(pid => {
                const p = allPlayersData.find(pl => pl.id === pid);
                if(p) currentCounts[p.position]++;
            });
            if (draftedPlayers.size >= SQUAD_LIMITS.TOTAL) { showAlert("×”×¡×’×œ ××œ× (15 ×©×—×§× ×™×)."); return; }
            if (currentCounts[player.position] >= SQUAD_LIMITS[player.position]) { showAlert(`××›×¡×ª ×”-${player.position} ××œ××”.`); return; }
            
            draftedPlayers.set(player.id, player.id);
            watchlistPlayers.delete(player.id);
            saveAndRender();
        }

        function handleUndraft(id) {
            draftedPlayers.delete(id);
            saveAndRender();
        }

        function handleWatchlistToggle(id) {
            if (watchlistPlayers.has(id)) {
                watchlistPlayers.delete(id);
            } else {
                watchlistPlayers.set(id, id);
            }
            saveAndRender();
        }
        
        function handleReset() { modalEl.classList.remove('hidden'); }
        function confirmReset() {
            draftedPlayers.clear();
            watchlistPlayers.clear();
            saveAndRender();
            showAlert("×”×§×‘×•×¦×” ×•×¨×©×™××ª ×”××¢×§×‘ ××•×¤×¡×• ×‘×”×¦×œ×—×”.");
            closeModal();
        }
        function closeModal() { modalEl.classList.add('hidden'); }

        function saveAndRender() {
            localStorage.setItem('fplDraftKit_v8_draft', JSON.stringify(Array.from(draftedPlayers.keys())));
            localStorage.setItem('fplDraftKit_v8_watchlist', JSON.stringify(Array.from(watchlistPlayers.keys())));
            renderTable();
            renderSquad();
            renderWatchlist();
        }
        
        function showAlert(message) {
            const alertBox = document.getElementById('alert-box');
            document.getElementById('alert-message').textContent = message;
            alertBox.classList.remove('opacity-0', '-translate-y-12');
            alertBox.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                alertBox.classList.remove('opacity-100', 'translate-y-0');
                alertBox.classList.add('opacity-0', '-translate-y-12');
            }, 3000);
        }

        function startApp(data) {
            allPlayersData = processPlayerData(data);
            calculateRanks(allPlayersData); 
            setupFilters(allPlayersData);
            saveAndRender();
            
            loader.classList.add('hidden');
            app.classList.remove('hidden');
            
            // Event Listeners
            document.querySelectorAll('#name-filter, #position-filter, #team-filter, #status-filter, #price-filter, #points-filter').forEach(el => {
                el.addEventListener('input', renderTable);
            });

            document.querySelector('#players-table thead').addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (!th || !th.dataset.sort) return;
                const key = th.dataset.sort;
                sortConfig.direction = (sortConfig.key === key && sortConfig.direction === 'desc') ? 'asc' : 'desc';
                sortConfig.key = key;
                renderTable();
            });

            document.getElementById(`players-table-body`).addEventListener('click', e => {
                const draftBtn = e.target.closest('.draft-btn');
                if (draftBtn) handleDraft(parseInt(draftBtn.dataset.id));
                
                const watchlistBtn = e.target.closest('.watchlist-btn');
                if (watchlistBtn) handleWatchlistToggle(parseInt(watchlistBtn.dataset.id));
            });

            document.getElementById('watchlist').addEventListener('click', e => {
                const draftBtn = e.target.closest('.draft-from-watchlist-btn');
                if (draftBtn) handleDraft(parseInt(draftBtn.dataset.id));

                const removeBtn = e.target.closest('.remove-from-watchlist-btn');
                if (removeBtn) handleWatchlistToggle(parseInt(removeBtn.dataset.id));
            });

            document.getElementById('reset-squad-btn').addEventListener('click', handleReset);
            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            document.getElementById('modal-confirm-btn').addEventListener('click', confirmReset);

            document.getElementById('pitch').addEventListener('click', e => {
                const shirt = e.target.closest('.undraft-btn');
                if (shirt) handleUndraft(parseInt(shirt.dataset.id));
            });
            document.getElementById('bench').addEventListener('click', e => {
                const shirt = e.target.closest('.undraft-btn');
                if (shirt) handleUndraft(parseInt(shirt.dataset.id));
            });
        }
    });
    </script>
</body>
</html>
